name: searchsocket-prune

on:
  schedule:
    - cron: "0 4 * * *" # Daily at 4 AM UTC
  workflow_dispatch:
    inputs:
      older-than:
        description: "TTL cutoff (e.g. 30d, 12h)"
        required: false
        default: "30d"
      dry-run:
        description: "Dry-run only (no deletions)"
        required: false
        type: boolean
        default: false

concurrency:
  group: searchsocket-prune
  cancel-in-progress: false

jobs:
  prune:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required: prune uses git branch -r to detect active scopes

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install --frozen-lockfile
      - run: pnpm build

      # Dry-run first to capture what will be pruned
      - name: Preview stale scopes
        id: preview
        run: |
          OLDER_THAN="${{ inputs.older-than || '30d' }}"
          echo "## SearchSocket Prune Preview" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Cutoff:** \`--older-than ${OLDER_THAN}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          pnpm searchsocket prune --older-than "$OLDER_THAN" 2>&1 | tee /tmp/prune-preview.txt
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat /tmp/prune-preview.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MILVUS_URI: ${{ secrets.MILVUS_URI }}
          MILVUS_TOKEN: ${{ secrets.MILVUS_TOKEN }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}

      # Apply deletions (skipped on manual dry-run)
      - name: Apply prune
        if: ${{ !inputs.dry-run }}
        run: |
          OLDER_THAN="${{ inputs.older-than || '30d' }}"
          pnpm searchsocket prune --older-than "$OLDER_THAN" --apply
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MILVUS_URI: ${{ secrets.MILVUS_URI }}
          MILVUS_TOKEN: ${{ secrets.MILVUS_TOKEN }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
